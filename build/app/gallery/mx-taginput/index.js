define("app/gallery/mx-taginput/suggest",["magix","$","../mx-monitor/index"],function(e,t,i){var o=e("magix"),s=e("$"),r=e("../mx-monitor/index");o.applyStyle("p84",".p84-572{position:absolute;border:1px solid #e6e6e6;padding:10px;font-size:12px;max-height:284px;overflow:auto;list-style:none;border-radius:4px;background-color:#fff;display:none;z-index:10}.p84-f6f{padding:5px 10px;cursor:default}.p84-dfe{color:#333;background-color:#f0f0f0;border-radius:4px;text-decoration:none;outline:0}"),i.exports=o.View.extend({tmpl:{html:'<ul mx-guid="g0" class="p84-572" style="width:<%=$$.width%>px" mx-mouseout="out()" mx-mousemove="move()">1</ul>',subs:[{s:"1",keys:["width","list","valueKey","viewId","textKey"],tmpl:'<%for(var i=0,one;i<$$.list.length;i++){one=$$.list[i]%><li class="p84-f6f" data-idx="<%!i%>" mx-click="pick({key:\'<%=$$.valueKey?one[$$.valueKey]:one%>\'})" id="sg_<%!$$.viewId%>_<%!i%>"><%=$$.textKey?one[$$.textKey]:one%></li><%}%>',path:'ul[mx-guid="g0"]',attr:'style="width:<%=$$.width%>px"',attrs:[{n:"style"}],mask:"21111"}]},init:function(e){var t=this;t.$scrollTop=e.scrollTop||0,t.$list=e.list||[],t.$offsetLeft=0|(e.offsetLeft||0),r.setup(),t.on("destroy",function(){r.teardown(),t.$oNode.off("keyup paste input",t.$watch).off("focus",t.$show)}),t.updater.set({viewId:t.id,width:e.width||340,textKey:e.textKey,valueKey:e.valueKey}),t.$map=e.map||o.toMap(t.$list,e.valueKey),t.$idx=-1,t.$relateIds=[t.id,"suggest_"+t.id],e.relateIds&&(t.$relateIds=t.$relateIds.concat(e.relateIds.split(",")))},inside:function(e){for(var t=this,i=t.$relateIds,s=0;s<i.length;s++)if(o.inside(e,i[s]))return!0;return!1},update:function(e,t){var i=this;t||(i.$list=e,i.$map=o.toMap(e,i.updater.get("valueKey"))),i.$idx=-1,i.updater.digest({list:i.$slist=e})},render:function(){var e=this,t=s("#"+e.id);e.$oNode=t,t.on("focus",e.$show=s.proxy(e.show,e)).on("keyup paste input",e.$watch=s.proxy(e.filter,e));var i="suggest_"+e.id;s("<div />").attr("id",i).insertAfter(t),e.updater.to(i),e.update(e.$list),e.$rNode=s("#"+i+" ul"),setTimeout(e.wrapAsync(function(){e.$rNode.prop("scrollTop",e.$scrollTop)}),0)},filter:function(e){var t=this;t.$shown||t.show();var i=t.$slist;if(40==e.keyCode)t.normal(),t.$idx++,t.$idx>=i.length&&(t.$idx=0),t.highlight();else if(38==e.keyCode)t.normal(),t.$idx--,t.$idx<0&&(t.$idx=i.length-1),t.highlight();else if(13==e.keyCode){if(t.$idx>-1&&t.$idx<t.$slist.length){var o=t.$slist[t.$idx];t.$oNode.trigger({type:"pick",item:o}),t.normal(),t.$idx=-1,t.hide()}}else{var r=s.trim(e.target.value);if(r!=t.$val)if(t.$val=r,r){for(var d=[],a=t.$list.slice(),l=t.updater.get("textKey"),p=void 0,n=0,g=void 0;n<a.length;n++)g=a[n],p=l?g[l]:g,(p+"").indexOf(r)>=0&&d.push(g);t.update(d,!0)}else t.update(t.$list,!0)}},show:function(){var e=this;if(!e.$shown){e.$shown=!0,r.add(e);var t=e.$oNode.position();e.$rNode.show().css({left:t.left+e.$offsetLeft,top:t.top+e.$oNode.outerHeight()+10})}},normal:function(){var e=this;s("#sg_"+e.id+"_"+e.$idx).removeClass("p84-dfe")},highlight:function(e){var t=this,i=s("#sg_"+t.id+"_"+t.$idx);if(i.addClass("p84-dfe"),!e&&i.length){t.$ignore=1;var o=i.outerHeight(),r=(t.$idx+1)*o,d=t.$rNode,a=d.height(),l=d.prop("scrollTop"),p=Math.ceil(a/o);r<l+o?d.prop("scrollTop",r-o):r>l+a&&d.prop("scrollTop",(t.$idx+2-p)*o)}},hide:function(){var e=this;e.$shown&&(e.$shown=!1,r.remove(e),e.$rNode.hide())},"pick<click>":function(e){var t=this,i=t.updater,o=t.$map,s=i.get("valueKey"),r=e.params.key,d=s?o[r]:r;t.$oNode.trigger({type:"pick",item:d,scrollTop:t.$rNode.prop("scrollTop")}),t.hide()},"out<mouseout>":function(e){if(!o.inside(e.relatedTarget,e.eventTarget)){var t=this;t.normal(),t.$idx=-1}},"move<mousemove>":function(e){var t=this;if(t.$ignore)return void delete t.$ignore;var i=s(e.target);if(i.is("li")){var o=i.data("idx");o!=t.$idx&&(t.normal(),t.$idx=o,t.highlight(!0))}}})}),define("app/gallery/mx-taginput/index",["magix","$"],function(e,t,i){var o=e("magix");o.applyStyle("pe4",".pe4-ef3{height:auto;min-height:32px;padding:2px 7px;position:relative}.pe4-ipt{height:auto;cursor:text}.pe4-7b4{position:absolute;left:10px;top:6px;color:#757575;user-select:none}.pe4-f6f{position:relative;display:inline-block;margin:1px;cursor:pointer;background-color:#eee;border-radius:4px}.pe4-8bc{width:1px;visibility:hidden}.pe4-ec6{float:left;border-right:1px solid #fff;max-width:200px;overflow:hidden}.pe4-153,.pe4-ec6{display:inline-block;padding:2px 4px}.pe4-153{width:20px;font-weight:bolder;text-align:center;color:#999}.pe4-92a{border:none;outline:none;height:18px;padding:0;width:20px;margin:1px;position:relative;z-index:1;background:transparent}");var s=e("$");i.exports=o.View.extend({tmpl:{html:'<div mx-guid="g3" class="pe4-ipt" mx-click="focus()" id="ipt_<%=$$.viewId%>">1</div>',subs:[{s:"1",keys:["viewId","items","placeholder","textKey"],tmpl:'<%if(!$$.items.length&&$$.placeholder){%><div class="pe4-7b4"><%=$$.placeholder%></div><%}if($$.items.length){for(var i=0;i<$$.items.length;i++){var one=$$.items[i];%><div class="pe4-f6f" mx-click="stop()"><div class="pe4-ec6 p16-9e0"><%=$$.textKey?one[$$.textKey]:one%></div><div class="pe4-153" mx-click="delete({idx:<%!i%>})">x</div></div><%}}else{%><div class="pe4-f6f pe4-8bc" mx-click="stop()"><div class="pe4-153" mx-click="delete({idx:<%!i%>})">x</div></div><%}%><input mx-guid="g1" mx-keydown="check()" mx-input="check()" mx-paste="check()" mx-view="app/gallery/mx-taginput/suggest?list=<%@$$.list%>&map=<%@$$.map%>&textKey=<%@$$.textKey%>&valueKey=<%@$$.valueKey%>&relateIds=ipt_<%=$$.viewId%>&offsetLeft=-11&scrollTop=<%@$$.scrollTop%>" class="pe4-92a" autocomplete="off" mx-pick="add()" mx-click="stop()"/>',path:'div[mx-guid="g3"]',attr:'id="ipt_<%=$$.viewId%>"',attrs:[{n:"id",p:1}],mask:"3111"},{keys:["list","map","valueKey","viewId","scrollTop"],path:'input[mx-guid="g1"]',pKeys:["items","placeholder","textKey"],attr:'mx-view="app/gallery/mx-taginput/suggest?list=<%@$$.list%>&map=<%@$$.map%>&textKey=<%@$$.textKey%>&valueKey=<%@$$.valueKey%>&relateIds=ipt_<%=$$.viewId%>&offsetLeft=-11&scrollTop=<%@$$.scrollTop%>"',attrs:[{n:"mx-view",v:1}]}]},init:function(e){var t=this;t.$list=e.list||[];var i=e.textKey,r=e.valueKey;t.$map=o.toMap(t.$list,r),t.$oNode=s("#"+t.id),t.updater.set({placeholder:e.placeholder||"",map:t.$map,textKey:i,valueKey:r}),t.updateSelected(e.selected)},getSuggest:function(){for(var e=this,t=e.updater,i=t.get("sMap"),o=t.get("valueKey"),s=e.$list,r=[],d=0,a=void 0,l=void 0;d<s.length;d++)a=s[d],l=o?a[o]:a,i[l]||r.push(a);return r},render:function(){var e,t=this;t.$oNodeIsInput?(e="core_"+t.id,s('<div id="'+e+'" />').insertAfter("#"+t.id),t.updater.to(e)):e=t.id,t.updater.digest({list:t.getSuggest(),viewId:t.id});var i=s("#"+e);i.addClass("pe4-ef3"),t.$rNode=i,t.updateTrigger()},updateTrigger:function(){var e=this,t=e.$rNode;e.$trigger=t.find("input"),e.$trigger.width(20);var i=s("#ipt_"+e.id).width()-e.$trigger.position().left;e.$trigger.width(i>=20?i:20)},updateSelected:function(e){var t=this;e=e||"",e=(e+"").split(",");for(var i=[],o={},s=t.$map,r=t.updater.get("textKey"),d=0,a=void 0;d<e.length;d++)(a=e[d])&&(o[a]=1,i.push(r?s[a]:a));t.updater.set({sMap:o,items:i}),t.$oNode.val(e.join(","))},val:function(e){var t=this;return e&&(t.updateSelected(e),t.updater.set({list:t.getSuggest()}).digest(),t.updateTrigger(),t.triggerEvent()),t.updater.get("items")},triggerEvent:function(){for(var e=this,t=e.updater,i=[],o=t.get("items"),r=t.get("valueKey"),d=0,a=void 0;d<o.length;d++)a=o[d],i.push(r?a[r]:a);s("#"+e.id).val(i.join(",")).trigger({type:"change",ids:i,items:t.get("items")})},"check<keydown,input,paste>":function(e){var t=this,i=e.eventTarget.value;if(t.$val!==i){t.$val=i;var o=t.$rNode.find(".pe4-7b4");i?o.hide():o.show()}if(!i&&"keydown"==e.type&&8==e.keyCode){var s=t.updater.get("items").length-1;s>-1&&(t["delete<click>"]({params:{idx:s}}),t.$trigger.focus())}},"add<pick>":function(e){e.stopPropagation();var t=this,i=t.updater,o=i.get("items"),s=i.get("sMap"),r=e.item,d=i.get("valueKey"),a=d?r[d]:r;s[a]||(s[a]=1,o.push(r),i.digest({items:o,scrollTop:e.scrollTop,list:t.getSuggest()}),t.updateTrigger(),t.$trigger.focus(),t.triggerEvent())},"focus<click>":function(){this.$trigger.focus()},"delete<click>":function(e){var t=this,i=t.updater,o=i.get("items"),s=i.get("sMap"),r=i.get("valueKey"),d=e.params.idx,a=o[d];delete s[r?a[r]:a],o.splice(e.params.idx,1),i.digest({items:o,list:t.getSuggest()}),t.updateTrigger(),t.triggerEvent()},"stop<click>":function(e){e.stopPropagation()}})});