define("app/gallery/mx-taginput/suggest",["magix","$","../mx-monitor/index"],function(e,t,i){var d=e("magix"),a=e("$"),o=e("../mx-monitor/index");d.applyStyle("pabcd84",".pabcd84-572{position:absolute;border:1px solid #e6e6e6;padding:10px;font-size:12px;max-height:284px;overflow:auto;list-style:none;border-radius:4px;background-color:#fff;display:none;z-index:10}.pabcd84-f6f{padding:5px 10px;cursor:default}.pabcd84-dfe{color:#333;background-color:#f0f0f0;border-radius:4px;text-decoration:none;outline:0}"),i.exports=d.View.extend({tmpl:{html:'<ul mx-guid="g0" class="pabcd84-572" style="width:<%=$$.width%>px" mx-mouseout="out()" mx-mousemove="move()">1</ul>',subs:[{s:"1",keys:["width","list","valueKey","viewId","textKey"],tmpl:'<%for(var i=0,one;i<$$.list.length;i++){one=$$.list[i]%><li class="pabcd84-f6f" data-idx="<%!i%>" mx-click="pick({key:\'<%=$$.valueKey?one[$$.valueKey]:one%>\'})" id="sg_<%!$$.viewId%>_<%!i%>"><%=$$.textKey?one[$$.textKey]:one%></li><%}%>',path:'ul[mx-guid="g0"]',attr:'style="width:<%=$$.width%>px"',attrs:[{n:"style"}],mask:"21111"}]},init:function(e){var t=this;t.$scrollTop=e.scrollTop||0,t.$list=e.list||[],t.$offsetLeft=0|(e.offsetLeft||0),o.setup(),t.on("destroy",function(){o.teardown(),t.$oNode.off("keyup paste input",t.$watch).off("focus",t.$show)}),t.updater.set({viewId:t.id,width:e.width||340,textKey:e.textKey,valueKey:e.valueKey}),t.$map=e.map||d.toMap(t.$list,e.valueKey),t.$idx=-1,t.$relateIds=[t.id,"suggest_"+t.id],e.relateIds&&(t.$relateIds=t.$relateIds.concat(e.relateIds.split(",")))},inside:function(e){for(var t=this,i=t.$relateIds,a=0;a<i.length;a++)if(d.inside(e,i[a]))return!0;return!1},update:function(e,t){var i=this;t||(i.$list=e,i.$map=d.toMap(e,i.updater.get("valueKey"))),i.$idx=-1,i.updater.digest({list:i.$slist=e})},render:function(){var e=this,t=a("#"+e.id);e.$oNode=t,t.on("focus",e.$show=a.proxy(e.show,e)).on("keyup paste input",e.$watch=a.proxy(e.filter,e));var i="suggest_"+e.id;a("<div />").attr("id",i).insertAfter(t),e.updater.to(i),e.update(e.$list),e.$rNode=a("#"+i+" ul"),setTimeout(e.wrapAsync(function(){e.$rNode.prop("scrollTop",e.$scrollTop)}),0)},filter:function(e){var t=this;t.$shown||t.show();var i=t.$slist;if(40==e.keyCode)t.normal(),t.$idx++,t.$idx>=i.length&&(t.$idx=0),t.highlight();else if(38==e.keyCode)t.normal(),t.$idx--,t.$idx<0&&(t.$idx=i.length-1),t.highlight();else if(13==e.keyCode){if(t.$idx>-1&&t.$idx<t.$slist.length){var d=t.$slist[t.$idx];t.$oNode.trigger({type:"pick",item:d}),t.normal(),t.$idx=-1,t.hide()}}else{var o=a.trim(e.target.value);if(o!=t.$val)if(t.$val=o,o){for(var s=[],r=t.$list.slice(),l=t.updater.get("textKey"),p=void 0,n=0,c=void 0;n<r.length;n++)c=r[n],p=l?c[l]:c,(p+"").indexOf(o)>=0&&s.push(c);t.update(s,!0)}else t.update(t.$list,!0)}},show:function(){var e=this;if(!e.$shown){e.$shown=!0,o.add(e);var t=e.$oNode.position();e.$rNode.show().css({left:t.left+e.$offsetLeft,top:t.top+e.$oNode.outerHeight()+10})}},normal:function(){var e=this;a("#sg_"+e.id+"_"+e.$idx).removeClass("pabcd84-dfe")},highlight:function(e){var t=this,i=a("#sg_"+t.id+"_"+t.$idx);if(i.addClass("pabcd84-dfe"),!e&&i.length){t.$ignore=1;var d=i.outerHeight(),o=(t.$idx+1)*d,s=t.$rNode,r=s.height(),l=s.prop("scrollTop"),p=Math.ceil(r/d);o<l+d?s.prop("scrollTop",o-d):o>l+r&&s.prop("scrollTop",(t.$idx+2-p)*d)}},hide:function(){var e=this;e.$shown&&(e.$shown=!1,o.remove(e),e.$rNode.hide())},"pick<click>":function(e){var t=this,i=t.updater,d=t.$map,a=i.get("valueKey"),o=e.params.key,s=a?d[o]:o;t.$oNode.trigger({type:"pick",item:s,scrollTop:t.$rNode.prop("scrollTop")}),t.hide()},"out<mouseout>":function(e){if(!d.inside(e.relatedTarget,e.eventTarget)){var t=this;t.normal(),t.$idx=-1}},"move<mousemove>":function(e){var t=this;if(t.$ignore)return void delete t.$ignore;var i=a(e.target);if(i.is("li")){var d=i.data("idx");d!=t.$idx&&(t.normal(),t.$idx=d,t.highlight(!0))}}})}),define("app/gallery/mx-taginput/index",["magix","$"],function(e,t,i){var d=e("magix");d.applyStyle("pabcde4",".pabcde4-ef3{height:auto;min-height:32px;padding:2px 7px;position:relative}.pabcde4-ipt{height:auto;cursor:text}.pabcde4-7b4{position:absolute;left:10px;top:6px;color:#757575;user-select:none}.pabcde4-f6f{position:relative;display:inline-block;margin:1px;cursor:pointer;background-color:#eee;border-radius:4px}.pabcde4-8bc{width:1px;visibility:hidden}.pabcde4-ec6{float:left;border-right:1px solid #fff;max-width:200px;overflow:hidden}.pabcde4-153,.pabcde4-ec6{display:inline-block;padding:2px 4px}.pabcde4-153{width:20px;font-weight:bolder;text-align:center;color:#999}.pabcde4-92a{border:none;outline:none;height:18px;padding:0;width:20px;margin:1px;position:relative;z-index:1;background:transparent}");var a=e("$");i.exports=d.View.extend({tmpl:{html:'<div mx-guid="g3" class="pabcde4-ipt" mx-click="focus()" id="ipt_<%=$$.viewId%>">1</div>',subs:[{s:"1",keys:["viewId","items","placeholder","textKey"],tmpl:'<%if(!$$.items.length&&$$.placeholder){%><div class="pabcde4-7b4"><%=$$.placeholder%></div><%}if($$.items.length){for(var i=0;i<$$.items.length;i++){var one=$$.items[i];%><div class="pabcde4-f6f" mx-click="stop()"><div class="pabcde4-ec6 pabcd16-9e0"><%=$$.textKey?one[$$.textKey]:one%></div><div class="pabcde4-153" mx-click="delete({idx:<%!i%>})">x</div></div><%}}else{%><div class="pabcde4-f6f pabcde4-8bc" mx-click="stop()"><div class="pabcde4-153" mx-click="delete({idx:<%!i%>})">x</div></div><%}%><input mx-guid="g1" mx-keydown="check()" mx-input="check()" mx-paste="check()" mx-pick="add()" mx-click="stop()" mx-view="app/gallery/mx-taginput/suggest?list=<%@$$.list%>&map=<%@$$.map%>&textKey=<%@$$.textKey%>&valueKey=<%@$$.valueKey%>&relateIds=ipt_<%!$$.viewId%>&offsetLeft=-11&scrollTop=<%@$$.scrollTop%>" class="pabcde4-92a" autocomplete="off"/>',path:'div[mx-guid="g3"]',attr:'id="ipt_<%=$$.viewId%>"',attrs:[{n:"id",p:1}],mask:"3111"},{keys:["list","map","valueKey","viewId","scrollTop"],path:'input[mx-guid="g1"]',pKeys:["items","placeholder","textKey"],attr:'mx-view="app/gallery/mx-taginput/suggest?list=<%@$$.list%>&map=<%@$$.map%>&textKey=<%@$$.textKey%>&valueKey=<%@$$.valueKey%>&relateIds=ipt_<%!$$.viewId%>&offsetLeft=-11&scrollTop=<%@$$.scrollTop%>"',attrs:[{n:"mx-view",v:1}]}]},init:function(e){var t=this;t.$list=e.list||[];var i=e.textKey,o=e.valueKey;t.$map=d.toMap(t.$list,o),t.$oNode=a("#"+t.id),t.updater.set({placeholder:e.placeholder||"",map:t.$map,textKey:i,valueKey:o}),t.updateSelected(e.selected)},getSuggest:function(){for(var e=this,t=e.updater,i=t.get("sMap"),d=t.get("valueKey"),a=e.$list,o=[],s=0,r=void 0,l=void 0;s<a.length;s++)r=a[s],l=d?r[d]:r,i[l]||o.push(r);return o},render:function(){var e,t=this;t.$oNodeIsInput?(e="core_"+t.id,a('<div id="'+e+'" />').insertAfter("#"+t.id),t.updater.to(e)):e=t.id,t.updater.digest({list:t.getSuggest(),viewId:t.id});var i=a("#"+e);i.addClass("pabcde4-ef3"),t.$rNode=i,t.updateTrigger()},updateTrigger:function(){var e=this,t=e.$rNode;e.$trigger=t.find("input"),e.$trigger.width(20);var i=a("#ipt_"+e.id).width()-e.$trigger.position().left;e.$trigger.width(i>=20?i:20)},updateSelected:function(e){var t=this;e=e||"",e=(e+"").split(",");for(var i=[],d={},a=t.$map,o=t.updater.get("textKey"),s=0,r=void 0;s<e.length;s++)(r=e[s])&&(d[r]=1,i.push(o?a[r]:r));t.updater.set({sMap:d,items:i}),t.$oNode.val(e.join(","))},val:function(e){var t=this;return e&&(t.updateSelected(e),t.updater.set({list:t.getSuggest()}).digest(),t.updateTrigger(),t.triggerEvent()),t.updater.get("items")},triggerEvent:function(){for(var e=this,t=e.updater,i=[],d=t.get("items"),o=t.get("valueKey"),s=0,r=void 0;s<d.length;s++)r=d[s],i.push(o?r[o]:r);a("#"+e.id).val(i.join(",")).trigger({type:"change",ids:i,items:t.get("items")})},"check<keydown,input,paste>":function(e){var t=this,i=e.eventTarget.value;if(t.$val!==i){t.$val=i;var d=t.$rNode.find(".pabcde4-7b4");i?d.hide():d.show()}if(!i&&"keydown"==e.type&&8==e.keyCode){var a=t.updater.get("items").length-1;a>-1&&(t["delete<click>"]({params:{idx:a}}),t.$trigger.focus())}},"add<pick>":function(e){e.stopPropagation();var t=this,i=t.updater,d=i.get("items"),a=i.get("sMap"),o=e.item,s=i.get("valueKey"),r=s?o[s]:o;a[r]||(a[r]=1,d.push(o),i.digest({items:d,scrollTop:e.scrollTop,list:t.getSuggest()}),t.updateTrigger(),t.$trigger.focus(),t.triggerEvent())},"focus<click>":function(){this.$trigger.focus()},"delete<click>":function(e){var t=this,i=t.updater,d=i.get("items"),a=i.get("sMap"),o=i.get("valueKey"),s=e.params.idx,r=d[s];delete a[o?r[o]:r],d.splice(e.params.idx,1),i.digest({items:d,list:t.getSuggest()}),t.updateTrigger(),t.triggerEvent()},"stop<click>":function(e){e.stopPropagation()}})});