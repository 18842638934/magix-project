define("app/services/service",["magix","$"],function(e,n,t){var i=e("magix"),s=e("$"),r=i.Service.extend(function(e,n){});i.mix(r,{serviceList:[],taskList:[],Actions:{login:function(e){console.log("login process"),setTimeout(e,1e4)},vcode:function(e){setTimeout(e,1e3)}},addService:function(e,n,t){r.serviceList.push({sync:e,bag:n,callback:t})},addTask:function(e){var n=r.taskList;1!=n[e]?(n[e]=1,n.push(e),r.runTask()):console.log(e," in list ,ignore")},runService:function(){var e=r.serviceList.shift();e&&(console.log("run waiting list",e),e.sync(e.bag,e.callback),r.runService())},runTask:function(){if(!r.$run){r.$run=!0;var e=r.taskList,n=e.shift();if(n){var t=r.Actions[n];t?t(function(){console.log(n+" end"),delete e[n],delete r.$run,r.runTask()}):(delete e[n],delete r.$run,r.runTask())}else delete r.$run,r.runService()}},intervene:function(){return r.$run}});var c=function(e,n){if(r.intervene())r.addService(c,e,n);else{if(e.get("mock")){e.get("ctrl")?e.set("ctrl",""):e.set("url","./tmpl/apis/list2.json")}s.ajax({url:e.get("url")+"?r="+i.guid(),complete:function(t,i){if("error"==i)n({msg:t.statusText});else{var o=s.parseJSON(t.responseText);o.action?(console.log("need",o.action),r.addService(c,e,n),r.addTask(o.action)):(e.set("data",o),n())}}})}},o=i.Service.extend(c);o.add([{name:"list",url:"./tmpl/apis/list.json",cache:6e5},{name:"list1",url:"./tmpl/apis/list1.json"},{name:"list404",url:"./tmpl/apis/list404.json"},{name:"code",url:"./tmpl/apis/code.json",cache:6e5}]),i.mix(o,{ctor:function(){var e=this;e.on("rendercall",function(){delete e.$locker})},request:function(e){e=e||i.guid("r");var n=new o;return this.capture(e,n,!0),n},fetch:function(e,n){this.request().all(e,n)},save:function(e,n){var t=this,i=JSON.stringify(e);t.lock(i,function(){t.request(i+"_request").save(e,function(){t.unlock(i),n.apply(t,arguments)})})},lock:function(e,n){var t=this;t.$locker||(t.$locker={});var i=t.$locker;i[e]||(i[e]=n,n())},unlock:function(e){var n=this.$locker;n&&delete n[e]}}),t.exports=o});